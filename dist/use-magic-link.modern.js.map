{"version":3,"file":"use-magic-link.modern.js","sources":["../src/load-magic-link.js","../src/use-magic-link.js"],"sourcesContent":["import EventEmitter from 'event-emitter';\n\nconst events = new EventEmitter();\nlet MagicSDK = null;\nlet script = null;\nlet sdk = null;\n\nexport default async function loadMagicLink(key) {\n    if (sdk) {\n        return sdk;\n    }\n\n    if (key && MagicSDK) {\n        sdk = new MagicSDK(key)\n        return sdk;\n    }\n\n    if (!script) {\n        script = window.document.createElement('script');\n        script.async = true;\n        script.src = 'https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js';\n        script.id = 'magic-link-sdk';\n        script.onload = () => {\n            MagicSDK = window.Magic;\n            events.emit('loaded');\n        }\n        \n        document.head.appendChild(script);\n    }\n\n    if (!key) {\n        return\n    }\n\n    return new Promise((resolve) => {\n        events.once('loaded', () => {\n            if (sdk) {\n                resolve(sdk)\n                return;\n            }\n            \n            sdk = new MagicSDK(key);\n            resolve(sdk);\n        })\n    })\n}","import { useState, useEffect } from 'react'\nimport EventEmitter from 'event-emitter'\nimport unfetch from 'isomorphic-unfetch'\nimport { Sema } from 'async-sema'\nimport loadMagicLink from './load-magic-link'\n\nconst tokenSema = new Sema(1)\nconst loggedInSema = new Sema(1)\nconst loginEvents = new EventEmitter()\n\nconst ONE_MINUTE = 1000 * 60;\n\nlet currentLoginState = null\nlet currentToken = null\n\nif (typeof window !== 'undefined') {\n  loadMagicLink()\n}\n\nasync function getMagicToken (magicLinkKey) {\n  await tokenSema.acquire()\n  try {\n    if (currentToken && currentToken.expiredAt > Date.now()) {\n      return currentToken.token\n    }\n\n    const magic = await loadMagicLink(magicLinkKey);\n    const token = await magic.user.getIdToken()\n    setToken(token)\n    return token\n  } finally {\n    tokenSema.release()\n  }\n}\n\nasync function isLoggedIn (magicLinkKey) {\n  await loggedInSema.acquire()\n\n  try {\n    if (currentLoginState !== null) {\n      return currentLoginState\n    }\n\n    await getMagicToken(magicLinkKey)\n    currentLoginState = true\n  } catch (err) {\n    currentLoginState = false\n  } finally {\n    loggedInSema.release()\n  }\n\n  return currentLoginState\n}\n\nfunction setToken (token, lifespan = ONE_MINUTE * 15) {\n  currentToken = {\n    token,\n    expiredAt: Date.now() + lifespan - ONE_MINUTE\n  }\n}\n\nexport default function useAuth (magicLinkKey) {\n  if (!magicLinkKey) {\n    throw new Error('Magic Link publishableKey required as the first argument')  \n  }\n\n  const [loggedIn, setLoggedIn] = useState(currentLoginState !== null ? currentLoginState : false)\n  const [loading, setLoading] = useState(currentLoginState === null)\n  const [error, setError] = useState(null)\n  const [loggingIn, setLoggingIn] = useState(false)\n  const [loggingOut, setLoggingOut] = useState(false)\n\n  async function login (email) {\n    setError(null)\n    setLoggingIn(true)\n\n    try {\n      const magic = await loadMagicLink(magicLinkKey);\n      const token = await magic.auth.loginWithMagicLink({ email })\n      currentLoginState = true\n      setToken(token)\n      loginEvents.emit('loggedIn', true)\n      setLoggedIn(true)\n    } catch(err) {\n      setError(err);\n    } finally {\n      setLoggingIn(false)\n    }\n  }\n\n  async function logout () {\n    setError(null)\n    setLoggingOut(true)\n\n    try {\n      const magic = await loadMagicLink(magicLinkKey);\n      await magic.user.logout()\n      currentLoginState = null\n      currentToken = null\n      loginEvents.emit('loggedIn', false)\n      setLoggedIn(false)\n    } catch (err) {\n      setError(err)\n    } finally {\n      setLoggingOut(false)\n    }\n\n    return currentLoginState === null\n  }\n\n  async function fetch (url, opts = {}) {\n    const token = await getMagicToken(magicLinkKey)\n    if (token) {\n      opts.headers = opts.headers || {}\n      opts.headers.Authorization = `Bearer ${token}`\n    }\n\n    return unfetch(url, opts)\n  }\n\n  useEffect(() => {\n    if (!currentLoginState) {\n      isLoggedIn(magicLinkKey)\n        .then((loginState) => {\n          setLoggedIn(loginState)\n        })\n        .then(() => setLoading(false))\n    }\n\n    function watchLoggedIn (state) {\n      setLoggedIn(state)\n    }\n    loginEvents.on('loggedIn', watchLoggedIn)\n\n    return () => {\n      loginEvents.off('loggedIn', watchLoggedIn)\n    }\n  }, [currentLoginState])\n\n  return {\n    loggedIn,\n    loading,\n    error,\n    loggingIn,\n    loggingOut,\n    login,\n    logout,\n    fetch,\n    loginEvents\n  }\n}\n"],"names":["events","EventEmitter","MagicSDK","script","sdk","loadMagicLink","key","window","document","createElement","async","src","id","onload","Magic","emit","head","appendChild","Promise","resolve","once","tokenSema","Sema","loggedInSema","loginEvents","currentLoginState","currentToken","getMagicToken","magicLinkKey","acquire","expiredAt","Date","now","token","magic","user","getIdToken","setToken","release","lifespan","ONE_MINUTE","Error","loggedIn","setLoggedIn","useState","loading","setLoading","error","setError","loggingIn","setLoggingIn","loggingOut","setLoggingOut","useEffect","watchLoggedIn","state","err","isLoggedIn","then","loginState","on","off","login","email","auth","loginWithMagicLink","logout","fetch","url","opts","headers","Authorization","unfetch"],"mappings":"iJAEA,MAAMA,EAAS,IAAIC,EACnB,IAAIC,EAAW,KACXC,EAAS,KACTC,EAAM,oBAEoBC,EAAcC,GACxC,OAAIF,IAIAE,GAAOJ,GACPE,EAAM,IAAIF,EAASI,GACZF,IAGND,IACDA,EAASI,OAAOC,SAASC,cAAc,UACvCN,EAAOO,OAAQ,EACfP,EAAOQ,IAAM,uDACbR,EAAOS,GAAK,iBACZT,EAAOU,OAAS,KACZX,EAAWK,OAAOO,MAClBd,EAAOe,KAAK,WAGhBP,SAASQ,KAAKC,YAAYd,IAGzBG,MAIMY,QAASC,IAChBnB,EAAOoB,KAAK,SAAU,KACdhB,IAKJA,EAAM,IAAIF,EAASI,IAJfa,EAAQf,YAPpB,ICxBJ,MAAMiB,EAAY,IAAIC,EAAK,GACrBC,EAAe,IAAID,EAAK,GACxBE,EAAc,IAAIvB,EAIxB,IAAIwB,EAAoB,KACpBC,EAAe,KAMnBhB,eAAeiB,EAAeC,SACtBP,EAAUQ,UAChB,IACE,GAAIH,GAAgBA,EAAaI,UAAYC,KAAKC,MAChD,OAAON,EAAaO,MAGtB,MAAMC,QAAc7B,EAAcuB,GAC5BK,QAAcC,EAAMC,KAAKC,aAE/B,OADAC,EAASJ,GACFA,EART,QAUEZ,EAAUiB,WAuBd,SAASD,EAAUJ,EAAOM,EAAWC,KACnCd,EAAe,CACbO,MAAAA,EACAH,UAAWC,KAAKC,MAAQO,EA/CT,KAKG,oBAAXhC,QACTF,mBA6CF,SAAiCuB,GAC/B,IAAKA,EACH,UAAUa,MAAM,4DAGlB,MAAOC,EAAUC,GAAeC,EAA+B,OAAtBnB,GAA6BA,IAC/DoB,EAASC,GAAcF,EAA+B,OAAtBnB,IAChCsB,EAAOC,GAAYJ,EAAS,OAC5BK,EAAWC,GAAgBN,GAAS,IACpCO,EAAYC,GAAiBR,GAAS,GAqE7C,OAnBAS,EAAU,KASR,SAASC,EAAeC,GACtBZ,EAAYY,GAId,OAbK9B,GAtFTf,eAA2BkB,SACnBL,EAAaM,UAEnB,IACE,GAA0B,OAAtBJ,EACF,OAAOA,QAGHE,EAAcC,GACpBH,GAAoB,EACpB,MAAO+B,GACP/B,GAAoB,EARtB,QAUEF,EAAae,UAGf,OAAOb,EAuEHgC,CAAW7B,GACR8B,KAAMC,IACLhB,EAAYgB,KAEbD,KAAK,IAAMZ,GAAW,IAM3BtB,EAAYoC,GAAG,WAAYN,GAEpB,KACL9B,EAAYqC,IAAI,WAAYP,KAE7B,CAAC7B,IAEG,CACLiB,SAAAA,EACAG,QAAAA,EACAE,MAAAA,EACAE,UAAAA,EACAE,WAAAA,EACAW,MAzEFpD,eAAsBqD,GACpBf,EAAS,MACTE,GAAa,GAEb,IACE,MAAMhB,QAAc7B,EAAcuB,GAC5BK,QAAcC,EAAM8B,KAAKC,mBAAmB,CAAEF,MAAAA,IACpDtC,GAAoB,EACpBY,EAASJ,GACTT,EAAYT,KAAK,YAAY,GAC7B4B,GAAY,GACZ,MAAMa,GACNR,EAASQ,GARX,QAUEN,GAAa,KA4DfgB,OAxDFxD,iBACEsC,EAAS,MACTI,GAAc,GAEd,IACE,MAAMlB,QAAc7B,EAAcuB,SAC5BM,EAAMC,KAAK+B,SACjBzC,EAAoB,KACpBC,EAAe,KACfF,EAAYT,KAAK,YAAY,GAC7B4B,GAAY,GACZ,MAAOa,GACPR,EAASQ,GARX,QAUEJ,GAAc,GAGhB,OAA6B,OAAtB3B,GAwCP0C,MArCFzD,eAAsB0D,EAAKC,EAAO,IAChC,MAAMpC,QAAcN,EAAcC,GAMlC,OALIK,IACFoC,EAAKC,QAAUD,EAAKC,SAAW,GAC/BD,EAAKC,QAAQC,cAAiB,UAAStC,GAGlCuC,EAAQJ,EAAKC,IA+BpB7C,YAAAA"}